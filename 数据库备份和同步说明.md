# 数据库备份和代码同步说明

## 📋 功能说明

本项目提供了自动化的代码同步和数据库备份功能，可以一键将代码和数据库备份同步到 GitHub。

## 🚀 快速开始

### 方法一：使用统一脚本（推荐）

直接运行 `sync-code-and-database.bat`，这个脚本会：
1. ✅ 自动备份数据库到 `database-backups/` 目录
2. ✅ 将代码和数据库备份一起提交到 Git
3. ✅ 推送到 GitHub

```bash
# 双击运行或在命令行执行
sync-code-and-database.bat
```

### 方法二：分别执行

#### 1. 备份数据库

**使用 Node.js 脚本：**
```bash
node backup-database.js
```

**或使用 PowerShell 脚本：**
```powershell
.\backup-database.ps1
```

备份文件会保存到 `database-backups/` 目录，文件名格式：`backup-shanghai_tour-YYYYMMDD-HHMMSS.sql`

#### 2. 同步代码到 GitHub

```bash
# 使用现有的同步脚本
sync-to-github.bat

# 或手动执行 Git 命令
git add .
git commit -m "更新代码和数据库备份"
git push
```

## 📁 目录结构

```
tour/
├── database-backups/          # 数据库备份目录（会被提交到 GitHub）
│   └── backup-*.sql           # 备份文件
├── backup-database.js          # Node.js 备份脚本
├── backup-database.ps1         # PowerShell 备份脚本
└── sync-code-and-database.bat  # 统一同步脚本
```

## ⚙️ 配置要求

### 1. 数据库配置

确保 `.env` 文件中包含数据库配置：

```env
DB_NAME=shanghai_tour
DB_USER=root
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=3306
```

### 2. MySQL 工具要求

备份脚本需要 `mysqldump` 命令，确保：
- ✅ MySQL 已安装
- ✅ MySQL bin 目录已添加到系统 PATH

**添加 MySQL 到 PATH：**
1. 找到 MySQL 安装目录，例如：`C:\Program Files\MySQL\MySQL Server 8.0\bin`
2. 添加到系统环境变量 PATH 中
3. 或使用项目提供的脚本：`add-nodejs-path-simple.bat`（需要修改为 MySQL 路径）

### 3. Git 配置

确保已配置 Git 用户信息：

```bash
git config --global user.name "你的名字"
git config --global user.email "你的邮箱"
```

## 🔄 工作流程

1. **开发代码** → 修改项目文件
2. **运行备份脚本** → 自动备份数据库
3. **运行同步脚本** → 提交代码和备份到 Git
4. **推送到 GitHub** → 代码和数据库备份都上传到 GitHub

## 📝 注意事项

### 数据库备份

- ✅ 备份文件会自动添加时间戳，不会覆盖旧备份
- ✅ 备份文件保存在 `database-backups/` 目录
- ✅ 备份文件会被提交到 GitHub（用于版本控制）
- ⚠️ 如果数据库很大，备份文件可能较大，GitHub 有 100MB 文件大小限制

### Git 配置

- ✅ `.gitignore` 已配置，排除临时文件和旧的 dump 文件
- ✅ `database-backups/*.sql` 会被包含在 Git 中
- ⚠️ 敏感信息（如密码）应保存在 `.env` 文件中，不要提交到 Git

### GitHub 推送

如果推送时遇到身份验证问题，请参考 `GITHUB_SYNC_GUIDE.md`：
- 使用 Personal Access Token
- 或配置 SSH 密钥

## 🆘 常见问题

### 问题 1：找不到 mysqldump

**错误信息：** `未找到 mysqldump 命令`

**解决方案：**
1. 确认 MySQL 已安装
2. 将 MySQL bin 目录添加到 PATH：
   ```powershell
   # 临时添加（当前会话有效）
   $env:PATH += ";C:\Program Files\MySQL\MySQL Server 8.0\bin"
   
   # 永久添加：系统属性 → 环境变量 → PATH
   ```

### 问题 2：数据库连接失败

**错误信息：** `备份文件未创建`

**解决方案：**
1. 检查 `.env` 文件中的数据库配置
2. 确认 MySQL 服务正在运行
3. 确认数据库用户名和密码正确
4. 确认数据库名称存在

### 问题 3：备份文件太大

**解决方案：**
- GitHub 限制单个文件 100MB
- 如果备份文件过大，可以考虑：
  1. 只备份结构，不备份数据：`mysqldump --no-data`
  2. 压缩备份文件
  3. 使用 Git LFS（Large File Storage）

## 📚 相关文档

- `GITHUB_SYNC_GUIDE.md` - GitHub 同步详细指南
- `README.md` - 项目说明
- `INSTALL_AND_RUN.md` - 安装和运行说明

## ✅ 检查清单

同步前确认：

- [ ] MySQL 已安装且 mysqldump 可用
- [ ] `.env` 文件已配置数据库信息
- [ ] Git 已安装并配置用户信息
- [ ] GitHub 仓库已创建（首次使用）
- [ ] 代码已测试无误
- [ ] 敏感信息已从代码中移除

---

**提示：** 建议定期备份数据库，特别是在重要更新之前！
